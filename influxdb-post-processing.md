# Tutorial: InfluxDB 1.8 post-processing

Continuous queries, user credentials and access rights do not survive a round trip through backup and restore.

This is a [known issue](https://github.com/influxdata/influxdb/issues/21494) and the lack of activity suggests it is unlikely to be fixed.

## background

What continuous queries, user credentials and access rights have in common is that they are stored in:

```
~/IOTstack/volumes/influxdb/data/meta/meta.db
```

The `meta.db` file *is* included in the portable backup generated by `influxd` and it *is* faithfully archived and restored by IOTstackBackup. But, for some unknown reason, `influxd` does not reconstitute those properties from the portable backup.

This means it is reasonably likely that *all* properties which are stored in `meta.db` will suffer a similar fate. 

## workaround

IOTstackBackup provides a workaround for this problem. The workaround is supported in both:

* `iotstack_restore_influxdb`; and
* `iotstack_reload_influxdb`.

To take advantage of the feature you need to create a text file at the following path:

```
~/IOTstack/services/influxdb/iotstack_restore_influxdb.epilog
```

The file is expected to contain InfluxQL commands. There is no mechanism for automating its construction. You have to set it up yourself, by hand, and take responsibility for its validity.

If that *epilog file* exists when `iotstack_restore_influxdb` runs, its contents will be passed to the container for execution. This occurs after the databases have been restored.

You can test your epilog file like this:

```
$ cd ~/IOTstack/services/influxdb
$ docker cp iotstack_restore_influxdb.epilog influxdb:.
$ docker exec influxdb influx -import -path "iotstack_restore_influxdb.epilog"
```

The epilog file it is kept in the `services` directory so it is included in the general backup and restore. Because the general restore runs before the database restores, the epilog file will already be in place when the InfluxDB restore runs. 

## practical example

Here is an example. Make the following assumptions:

1. You are working in the influx CLI:

	```
	$ influx
	>
	```

2. You define the following users:

	```
	> CREATE USER "dba" WITH PASSWORD 'supremo' WITH ALL PRIVILEGES
	> CREATE USER "nodered" WITH PASSWORD 'nodereds_big_secret'
	> CREATE USER "grafana" WITH PASSWORD 'grafanas_little_secret'
	```

3. You have a `power` database to which you grant the following access rights:

	```
	> GRANT WRITE ON "power" TO "nodered"
	> GRANT READ ON "power" TO "grafana"
	```

4. You construct the following continuous query on the `power` database:

	```
	> CREATE CONTINUOUS QUERY max_voltage_cq ON power BEGIN SELECT max(voltage) INTO hikingVoltage FROM hiking GROUP BY time(5m) END
	```

The content of `iotstack_restore_influxdb.epilog` would simply be those same commands:

```
CREATE USER "dba" WITH PASSWORD 'supremo' WITH ALL PRIVILEGES
CREATE USER "nodered" WITH PASSWORD 'nodereds_big_secret'
CREATE USER "grafana" WITH PASSWORD 'grafanas_little_secret'
GRANT WRITE ON "power" TO "nodered"
GRANT READ ON "power" TO "grafana"
CREATE CONTINUOUS QUERY max_voltage_cq ON power BEGIN SELECT max(voltage) INTO hikingVoltage FROM hiking GROUP BY time(5m) END
```

Note:

* InfluxQL follows SQL conventions on comments. The following are valid comments:

	```
	-- this is a valid comment
	/* this is also a valid comment but it must be on one line */
	```
	
	These comments are invalid:
	
	```
	# this will cause influx to complain
	// this will also cause influx to complain
	/* influx does
	   not like C-style
	   multiline comments
	*/
	```

## command reconstruction

If you want to take advantage of the epilog workaround but you do not have a record of the necessary commands, you can usually reconstruct them by hand.

### users

Usernames can be retrieved via:

```
> SHOW USERS
user    admin
----    -----
dba     true
nodered false
grafana false
```

Passwords are stored as hashes so there is no way to recover and display the plain-text versions.

Templates:

* admin user:

	```
	CREATE USER "«user»" WITH PASSWORD '«password»' WITH ALL PRIVILEGES
	```

* non-admin user:

	```
	CREATE USER "«user»" WITH PASSWORD '«password»'
	```

Note:

* The use of both single- and double-quotes is intentional. Usernames must be wrapped in double-quotes and passwords must be wrapped in single quotes.

### grants

Grants can be retrieved by iterating the non-admin users:

```
> SHOW GRANTS FOR nodered
database privilege
-------- ---------
power    WRITE

> SHOW GRANTS FOR grafana
database privilege
-------- ---------
power    READ
```

Template:

```
GRANT «privilege» ON "«database»" TO "«user»"
```

### continuous queries

Your queries can be retrieved via:

```
> SHOW CONTINUOUS QUERIES
name: power
name           query
----           -----
max_voltage_cq CREATE CONTINUOUS QUERY max_voltage_cq ON power BEGIN SELECT max(voltage) INTO power.autogen.hikingVoltage FROM power.autogen.hiking GROUP BY time(5m) END
```

Just copy/paste the contents of the "query" field.
